[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "event_frequency": "All",
  "modified": "2025-12-16 14:52:02.587167",
  "module": "Price List",
  "name": "Item Price Calculation With VAT Rat",
  "reference_doctype": "Purchase Invoice",
  "script": "DEBUG = True  # Show verbose logs during submission\ntax_applicable_categories = [\"NONMEDICALS\"]  # Normalized category keys\n\n# MAIN PROCESS ON SUBMIT-\nif doc.docstatus == 1:  # Only when submitted\n    for row in doc.items:\n\n        # --- Fetch item ---\n        item = frappe.get_doc(\"Item\", row.item_code)\n\n        # --- Fetch linked markup values ---\n        classification = (item.custom_item_classification or \"\").strip()\n        group = (item.item_group or \"\").strip()\n        category = (item.custom_item_category or \"\").strip()\n        performance = (item.custom_product_performance or \"\").strip()\n\n        # Markup values (converted to factors)\n        try: A = float(frappe.db.get_value(\"Item Classification\", classification, \"base_markup\") or 0) / 100\n        except: A = 0\n\n        try: B = float(frappe.db.get_value(\"Item Group\", group, \"custom_base_markup\") or 0) / 100\n        except: B = 0\n\n        try: C = float(frappe.db.get_value(\"Item Category\", category, \"base_markup\") or 100) / 100\n        except: C = 1\n\n        try: D = float(frappe.db.get_value(\"Product Performance\", performance, \"base_markup\") or 100) / 100\n        except: D = 1\n\n        final_markup = (A + B) * C * D\n\n        warehouses = frappe.db.get_all(\n            \"Warehouse\",\n            filters={\"custom_include_in_valuation\": 1},\n            fields=[\"name\"]\n        )\n        warehouse_list = [w.name for w in warehouses]\n\n        if not warehouse_list:\n            frappe.throw(\"No warehouses have <b>Include in Valuation</b> enabled.\")\n\n        placeholders = \", \".join([\"%s\"] * len(warehouse_list))\n        warehouse_condition = f\"AND warehouse IN ({placeholders})\"\n        params = [row.item_code] + warehouse_list\n        \n        # GET CORRECT VALUATION RATE (IGNORE CANCELLED ENTRIES)\n        \n        valuation_entry = frappe.db.sql(f\"\"\"\n            SELECT MAX(incoming_rate) AS max_rate\n            FROM `tabStock Ledger Entry`\n            WHERE item_code = %s\n              AND docstatus = 1       -- submitted only\n              AND is_cancelled = 0    -- ignore cancelled valuation rows\n              AND incoming_rate > 0   -- ignore zero-valuation entries\n              {warehouse_condition}\n        \"\"\", tuple(params), as_dict=1)\n\n        if valuation_entry and valuation_entry[0].max_rate:\n            valuation = float(valuation_entry[0].max_rate)\n        else:\n            # Fallback to last purchase rate\n            valuation = float(frappe.db.get_value(\"Item\", row.item_code, \"last_purchase_rate\") or 0)\n            frappe.msgprint(f\"<b>{row.item_code}</b>: No valuation found. Using Last Purchase Rate ({valuation})\")\n\n        if not valuation:\n            continue\n\n\n        # APPLY MARKUP CALCULATION\n        new_price = valuation * (1 + final_markup)\n\n        # APPLY VAT IF APPLICABLE\n        try:\n            vat_rate = float(frappe.db.get_value(\"Item Category\", category, \"vat_rate\") or 0) / 100\n        except:\n            vat_rate = 0.0\n\n        if vat_rate > 0:\n            new_price = new_price * (1 + vat_rate)\n\n        # FETCH PREVIOUS SELLING PRICE\n        previous_selling_rate = frappe.db.get_value(\n            \"Item Price\",\n            {\"item_code\": row.item_code, \"price_list\": \"Standard Selling\"},\n            \"price_list_rate\"\n        ) or 0\n\n        row.custom_previous_item_rate = previous_selling_rate\n\n        # CREATE OR UPDATE ITEM PRICE RECORD\n        existing = frappe.get_all(\n            \"Item Price\",\n            filters={\"item_code\": row.item_code, \"price_list\": \"Standard Selling\"},\n            fields=[\"name\"]\n        )\n\n        if existing:\n            ip = frappe.get_doc(\"Item Price\", existing[0].name)\n            ip.price_list_rate = new_price\n            ip.reference = doc.name\n            ip.flags.ignore_validate = ip.flags.ignore_permissions = ip.flags.ignore_links = ip.flags.ignore_mandatory = True\n            ip.save()\n        else:\n            ip = frappe.get_doc({\n                \"doctype\": \"Item Price\",\n                \"price_list\": \"Standard Selling\",\n                \"item_code\": row.item_code,\n                \"price_list_rate\": new_price,\n                \"uom\": item.stock_uom,\n                \"reference\": doc.name\n            })\n            ip.flags.ignore_validate = ip.flags.ignore_permissions = ip.flags.ignore_links = ip.flags.ignore_mandatory = True\n            ip.insert()\n\n        # DEBUG LOG DISPLAY\n        if DEBUG:\n            total_markup_percent = (new_price / valuation - 1) * 100\n            debug_vat = vat_rate * 100\n            frappe.msgprint(f\"\"\"\n                <b>{row.item_code}</b><br><br>\n                Warehouses considered: <b>{\", \".join(warehouse_list)}</b><br><br>\n\n                Prev Selling Price: <b>{previous_selling_rate}</b><br>\n                Valuation Used: <b>{valuation}</b><br><br>\n\n                Classification (A): {A*100:.2f}%<br>\n                Group (B): {B*100:.2f}%<br>\n                Category (C): {C}<br>\n                Performance (D): {D}<br><br>\n\n                Final Markup %: <b>{final_markup*100:.2f}%</b><br>\n                VAT %: <b>{debug_vat:.2f}%</b><br><br>\n\n                New Selling Price: <b>{new_price}</b><br>\n                Total Increase from Valuation: <b>{total_markup_percent:.2f}%</b><br>\n                Reference Linked: <b>{doc.name}</b>\n            \"\"\", title=\"Markup Calculation Summary\")\n\n    doc.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "event_frequency": "All",
  "modified": "2025-12-16 14:53:23.828670",
  "module": "Price List",
  "name": "Item Price List After Cancell",
  "reference_doctype": "Purchase Invoice",
  "script": "# Revert Item Price when Purchase Invoice is cancelled\n\nif doc.docstatus == 2:      # CANCELLED\n\n    for row in doc.items:\n\n        item_code = row.item_code\n        previous_rate = row.custom_previous_item_rate   # custom field\n\n        if not previous_rate:\n            continue\n\n        # Fetch Item Price in Standard Selling\n        ip = frappe.get_all(\n            \"Item Price\",\n            filters={\n                \"item_code\": item_code,\n                \"price_list\": \"Standard Selling\"\n            },\n            fields=[\"name\"],\n            limit=1\n        )\n\n        if not ip:\n            continue\n\n        ip_name = ip[0].name\n\n        # Restore Selling Price\n        frappe.db.set_value(\"Item Price\", ip_name, \"price_list_rate\", previous_rate)\n        frappe.db.set_value(\"Item Price\", ip_name, \"reference\", \"\")\n",
  "script_type": "DocType Event"
 }
]